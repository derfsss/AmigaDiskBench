# Technical Implementation Plan - AmigaDiskBench v2.2.13

This document details the low-level data structures, algorithms, and logic required to implement the approved visualization enhancements.

## Data Structures

### 1. VizSeries (Grouping)
```c
typedef struct {
    char label[64];
    uint32 color_argb;
    BenchResult **results; /* Array of pointers to results in this series */
    uint32 count;
    float max_val;         /* Cached for scaling */
} VizSeries;
```

### 2. VizData (Container)
```c
typedef struct {
    VizSeries series[16];  /* Up to 16 unique series/colors */
    uint32 series_count;
    float global_max_y1;   /* Primary scale (MB/s) */
    float global_max_y2;   /* Secondary scale (IOPS for Hybrid) */
    uint32 total_points;
} VizData;
```

## Proposed Changes

### [Component] Data Aggregation (`gui_viz.c`)
- **`CollectVizData()`**:
    - Iterate filtered results.
    - Group by `ui.viz_color_by_idx` (Drive, Test Type, etc.).
    - Assign one of the 16 colors to each unique series.
    - Sort each series by the relevant X-axis (Block Size or Time).

### [Component] Rendering Engine (`gui_viz_render.c`)

#### 1. Color Palette (16 Colors)
A high-contrast palette prioritized for readability:
`0xBBDD00`, `0x0088FF`, `0xFF4444`, `0xFFAA00`, `0xAA44FF`, `0x00CCCC`, `0xFF66AA`, `0x888800`,
`0xEEFF22`, `0x22AAFF`, `0xFF77EE`, `0x77FF77`, `0xFFBB00`, `0x00CCEE`, `0xCCAAFF`, `0x88CC88`

#### 2. Legend Wrapping Algorithm
- Start at `MARGIN_LEFT`, `MARGIN_BOTTOM_START`.
- For each series:
    - Measure text width using `TextExtent()`.
    - If `current_x + color_box + text_width > box->Width - MARGIN_RIGHT`:
        - `current_x = MARGIN_LEFT`.
        - `current_y += row_height + 2`.
    - Render color box and label.
    - `current_x += color_box + text_width + spacing`.

#### 3. Scaling & Layout
- **X-Axis Mapping**:
    - *Line*: Linear mapping between indices or logarithmic for Block Sizes.
    - *Bar*: Divide `pw` by `category_count`, then sub-divide each category by `series_count` for grouped bars.
- **Y-Axis Mapping**:
    - Standardize `RenderLineChart` to handle multiple lines in one pass.
    - Implement `RenderBarChart` with spacing between series groups.

## Interaction & Tooltips
- Update `VizCheckHover()` to handle the multi-series layout.
- For Bar charts, hover detection will use "Bucket" logic (closest X category) instead of pixel proximity to dots.

## Verification
- Stress test with 16 drives/tests to ensure legend wrapping works.
- Verify Hybrid mode correctly aligns Bar centers with Line dots.
